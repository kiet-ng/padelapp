<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Americano – Live Round & Leaderboard (v17.2)</title>
  <style>
    :root{ --bg:#0b0f14; --card:#0f172a; --border:#1f2937; --muted:#9aa4b2; --fg:#e7ecf3; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    html{-webkit-text-size-adjust:100%}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .bar{position:sticky;top:0;background:rgba(11,15,20,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10;
         padding-top:env(safe-area-inset-top)}
    .bar .wrap{display:flex;gap:10px;align-items:center}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:4px 10px;border-radius:999px}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:12px 16px;border-radius:12px;border:1px solid #334155;background:#22c55e;color:#0b1118;
         font-weight:700;cursor:pointer;touch-action:manipulation}
    .btn.ghost{background:var(--card);color:var(--fg);border-color:#334155}
    .btn.danger{background:#7f1d1d;border-color:#7f1d1d;color:#fecaca}
    .btn.alt{background:#f59e0b;border-color:#f59e0b;color:#111827}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0}
    label{display:block;margin:12px 0 6px;font-size:14px;color:#9aa4b2}
    textarea,input,select{
      width:100%;padding:12px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--fg);
      font-size:16px;line-height:1.2; -webkit-appearance:none; appearance:none;
    }
    textarea{min-height:120px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #334155;padding:10px 8px;text-align:left}
    .hidden{display:none}
    #error{display:none;background:#3f1d20;border:1px solid #7f1d1d;color:#fecaca;border-radius:10px;padding:10px;margin-top:10px;white-space:pre-wrap}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .match{padding:12px;margin:12px 0;border:1px dashed #334155;border-radius:12px}
    .score{ display:grid;grid-template-columns:auto 1fr auto 1fr;gap:10px;align-items:center;margin-top:10px }
    .score input{ width:100%;max-width:140px;text-align:center;font-weight:700;padding:12px 10px }
    @media (max-width:520px){
      .wrap{padding:12px}
      .btn{padding:12px 14px}
      .score{grid-template-columns:1fr 1fr;grid-row-gap:8px}
      .score > :nth-child(1){grid-column:1;justify-self:start}
      .score > :nth-child(2){grid-column:2}
      .score > :nth-child(3){grid-column:1;justify-self:start}
      .score > :nth-child(4){grid-column:2}
    }
  </style>
  <script>
    window.addEventListener('error', function(e){
      var box = document.getElementById('error');
      if(!box) return;
      box.style.display = 'block';
      box.textContent = 'JS error: ' + (e.message || e.error || 'unknown');
    });
  </script>
</head>
<body>
  <div class="bar">
    <div class="wrap">
      <h2 style="margin:0">Americano – Live</h2>
      <span class="pill" id="status">ready</span>
      <div style="flex:1"></div>
      <button id="btnLeaderboard" class="btn ghost" disabled>Leaderboard</button>
      <button id="btnResetKeep" class="btn alt">Reset (keep players)</button>
      <button id="btnReset" class="btn danger">Reset</button>
    </div>
  </div>

  <div class="wrap">
    <div id="error"></div>

    <div id="setupCard" class="card">
      <h3>Setup</h3>
      <label>Players (one per line)</label>
      <textarea id="players" placeholder="Alice&#10;Bjørn&#10;Carla&#10;David&#10;Emma&#10;Filip&#10;Grete&#10;Henrik&#10;Iris"></textarea>

      <label>Courts</label>
      <input id="courts" type="number" value="2" min="1" inputmode="numeric" />

      <label>Points per match</label>
      <select id="points">
        <option value="16">16</option>
        <option value="20">20</option>
        <option value="24" selected>24</option>
        <option value="32">32</option>
      </select>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <div>
          <label>Total rounds mode</label>
          <select id="roundsMode">
            <option value="auto" selected>Auto (full cycle)</option>
            <option value="equal">Equal (balanced)</option>
            <option value="custom">Custom number</option>
            <option value="unlimited">Unlimited</option>
          </select>
        </div>

        <div id="equalWrap" class="hidden">
          <label>Equal round count</label>
          <select id="equalRounds"></select>
          <div id="equalNote" class="muted" style="font-size:13px;margin-top:6px"></div>
        </div>

        <div id="customRoundsWrap" class="hidden">
          <label>Total rounds (custom)</label>
          <input id="customRounds" type="number" min="1" value="9" inputmode="numeric" />
        </div>
      </div>

      <button class="btn" id="start" style="margin-top:14px">Start event</button>
    </div>

    <div id="roundCard" class="card hidden">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 id="roundTitle" style="margin:0">Round</h3>
        <div class="tags">
          <span class="pill" id="roundCount"></span>
          <span class="pill" id="pointsInfo"></span>
          <span class="pill hidden" id="sitInfo"></span>
        </div>
        <div style="flex:1"></div>
        <button class="btn ghost" id="prev">◀ Prev</button>
        <button class="btn ghost" id="next">Next ▶</button>
      </div>
      <div id="matches"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="submit">Submit round scores</button>
      </div>
    </div>

    <div id="leaderCard" class="card hidden">
      <div style="display:flex;align-items:center;gap:10px">
        <h3 style="margin:0">Leaderboard</h3>
        <div style="flex:1"></div>
        <button class="btn ghost" id="closeLeader">Back to round</button>
      </div>
      <table id="leader"><tr><th>#</th><th>Player</th><th class="muted">Record</th><th>Points</th></tr></table>
    </div>
  </div>

<script>
var $=function(s){return document.querySelector(s)}; var $$=function(s){return Array.prototype.slice.call(document.querySelectorAll(s));};
var state={
  names:[],courts:2,points:24,rounds:[],cur:0,
  totals:new Map(),results:[], unlimited:false, stats:new Map(),
  lastSit:new Set(),
  pairCount:new Map() // Map<player, Map<player, count>>
};

function err(msg){ var e=$('#error'); e.textContent=msg; e.style.display='block'; }
function clearErr(){ var e=$('#error'); e.textContent=''; e.style.display='none'; }

/* Recreate the players textarea to guarantee it's editable */
function recreatePlayersTextarea(preserveText){
  var oldTa = document.getElementById('players');
  if(!oldTa) return null;
  var value = preserveText ? (oldTa.value || '').trim() : '';
  var newTa = document.createElement('textarea');
  newTa.id = 'players';
  newTa.placeholder = oldTa.placeholder || 'Players, one per line';
  newTa.value = value;
  newTa.style.pointerEvents = 'auto';
  newTa.disabled = false; newTa.readOnly = false;
  newTa.setAttribute('rows', oldTa.getAttribute('rows') || '10');
  oldTa.parentNode.replaceChild(newTa, oldTa);
  return newTa;
}

function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
function gcd(a,b){ a=Math.abs(a); b=Math.abs(b); while(b){ var t=b; b=a%b; a=t; } return a||1; }

/* ===== Stats recompute ===== */
function initStats(){
  state.totals = new Map(state.names.map(function(n){return [n,0]}));
  state.stats = new Map(state.names.map(function(n){return [n,{w:0,d:0,l:0}]}));
}
function recomputeFromResults(){
  initStats();
  for(var ri=0; ri<state.rounds.length; ri++){
    var res = state.results[ri];
    if(!res) continue;
    var round = state.rounds[ri];
    for(var mi=0; mi<round.matches.length; mi++){
      var m = round.matches[mi];
      var r = res[mi];
      if(!r) continue;
      m.teamA.forEach(function(p){ state.totals.set(p, (state.totals.get(p)||0) + r.a); });
      m.teamB.forEach(function(p){ state.totals.set(p, (state.totals.get(p)||0) + r.b); });
      if(r.a>r.b){ m.teamA.forEach(function(p){ state.stats.get(p).w++; }); m.teamB.forEach(function(p){ state.stats.get(p).l++; }); }
      else if(r.b>r.a){ m.teamB.forEach(function(p){ state.stats.get(p).w++; }); m.teamA.forEach(function(p){ state.stats.get(p).l++; }); }
      else { m.teamA.forEach(function(p){ state.stats.get(p).d++; }); m.teamB.forEach(function(p){ state.stats.get(p).d++; }); }
    }
  }
}

/* ===== Pair-history helpers (teammates) ===== */
function getPairCount(a,b){
  if(a===b) return 9999;
  var m = state.pairCount.get(a); if(!m){ m=new Map(); state.pairCount.set(a,m); }
  return m.get(b)||0;
}
function incPairCount(a,b){
  if(a===b) return;
  var m = state.pairCount.get(a); if(!m){ m=new Map(); state.pairCount.set(a,m); }
  m.set(b, (m.get(b)||0)+1);
  var m2 = state.pairCount.get(b); if(!m2){ m2=new Map(); state.pairCount.set(b,m2); }
  m2.set(a, (m2.get(a)||0)+1);
}

/* ===== Strict-cap teammate pairing =====
   Tries cap=0 (no repeat teammates this event). If impossible, cap=1, then 2, ...
   Only allows repeats when mathematically forced. */
function makePairsUnique(players){
  var P = players.slice();

  // Hardest-first heuristic: players with higher prior links go first
  P.sort(function(a,b){
    var sa=0,sb=0;
    for(var i=0;i<P.length;i++){
      var x=P[i]; if(x===a||x===b) continue;
      sa+=getPairCount(a,x); sb+=getPairCount(b,x);
    }
    return sb-sa; // desc
  });

  function tryBuildWithCap(cap){
    var used = new Set();
    var curPairs = [];

    function backtrack(){
      if(curPairs.length*2 === P.length) return true;

      // pick next unassigned
      var a=null;
      for(var i=0;i<P.length;i++){ var p=P[i]; if(!used.has(p)){ a=p; break; } }
      used.add(a);

      // candidates who have pairCount <= cap with 'a'
      var cands=[];
      for(var j=0;j<P.length;j++){
        var q=P[j];
        if(q===a || used.has(q)) continue;
        var pc = getPairCount(a,q);
        if(pc <= cap) cands.push({ q:q, score:pc });
      }
      if(cands.length===0){ used.delete(a); return false; }

      cands.sort(function(x,y){
        if(x.score !== y.score) return x.score - y.score; // fewer repeats first
        return Math.random() - 0.5;                        // small tiebreaker
      });

      for(var k=0;k<cands.length;k++){
        var b=cands[k].q;
        used.add(b);
        curPairs.push([a,b]);
        if(backtrack()) return true;
        curPairs.pop();
        used.delete(b);
      }
      used.delete(a);
      return false;
    }

    return backtrack() ? curPairs.slice() : null;
  }

  for(var cap=0; cap<=3; cap++){
    var res = tryBuildWithCap(cap);
    if(res) return res;
  }

  // Fallback (rare)
  var pool = players.slice(); shuffle(pool);
  var best=[]; for(var i=0;i<pool.length;i+=2) best.push([pool[i], pool[i+1]]);
  return best;
}

/* Build matches from strictly-capped teams; also increment teammate history */
function pairUpUnique(active){
  var teams = makePairsUnique(active);
  for(var i=0;i<teams.length;i++){ incPairCount(teams[i][0], teams[i][1]); }

  // shuffle to vary court assignment a bit
  var tmp = teams.slice(); shuffle(tmp);

  var matches=[];
  for(i=0;i<tmp.length;i+=2){
    matches.push({ teamA: tmp[i], teamB: tmp[i+1] });
  }
  return matches;
}

/* ===== Display helpers ===== */
function buildScoreInputs(card, match){
  var teamALabel = match.teamA.join(' & ');
  var teamBLabel = match.teamB.join(' & ');
  var sc=document.createElement('div'); sc.className='score';

  var aLabel = document.createElement('span'); aLabel.textContent = teamALabel+':';
  var bLabel = document.createElement('span'); bLabel.textContent = teamBLabel+':';

  var aIn=document.createElement('input');
  aIn.type='number'; aIn.min='0'; aIn.step='1';
  aIn.placeholder=teamALabel; aIn.setAttribute('aria-label', teamALabel);
  aIn.setAttribute('inputmode','numeric'); aIn.setAttribute('pattern','[0-9]*');

  var bIn=document.createElement('input');
  bIn.type='number'; bIn.min='0'; bIn.step='1';
  bIn.placeholder=teamBLabel; bIn.setAttribute('aria-label', teamBLabel);
  bIn.setAttribute('inputmode','numeric'); bIn.setAttribute('pattern','[0-9]*');

  var blurOnEnter = function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); ev.currentTarget.blur(); } };
  aIn.addEventListener('keydown', blurOnEnter);
  bIn.addEventListener('keydown', blurOnEnter);

  sc.appendChild(aLabel); sc.appendChild(aIn); sc.appendChild(bLabel); sc.appendChild(bIn);
  card.appendChild(sc);

  // start 0–0; complement as you type
  function clamp(v){ v = Math.max(0, Math.min(state.points, Number(v)||0)); return Math.round(v); }
  var lock=false; function sync(src, dst){ if(lock) return; lock=true; var val=clamp(src.value); var oth=Math.max(0, state.points - val); dst.value=oth; lock=false; }
  aIn.addEventListener('input', function(){ sync(aIn, bIn); }); bIn.addEventListener('input', function(){ sync(bIn, aIn); });
  aIn.value='0'; bIn.value='0';
}
function renderSitInfo(sit){
  var el = $('#sitInfo');
  if(sit && sit.length){ el.textContent = 'Sit-out: ' + sit.join(', '); el.classList.remove('hidden'); }
  else { el.classList.add('hidden'); el.textContent=''; }
}

function showRound(i){
  state.cur=i; var r=state.rounds[i];
  if(!r){ err('Internal: round not found'); return; }
  $('#roundTitle').textContent='Round '+(i+1);
  $('#roundCount').textContent = state.unlimited ? 'unlimited' : ('of '+state.rounds.length);
  $('#pointsInfo').textContent = 'to '+state.points+' pts';
  renderSitInfo(r.sit);
  var box=$('#matches'); box.innerHTML='';
  r.matches.forEach(function(m,idx){
    var div=document.createElement('div'); div.className='match';
    div.innerHTML='<b>Court '+(idx+1)+'</b>';
    buildScoreInputs(div, m); box.appendChild(div);
  });
  $('#prev').disabled=(i===0);
  $('#next').disabled = (!state.unlimited && i>=state.rounds.length-1);
}

/* ----- View helpers ----- */
function showLeaderboardView(){
  updateLeaderboard();
  document.getElementById('roundCard').classList.add('hidden');
  document.getElementById('leaderCard').classList.remove('hidden');
  document.getElementById('setupCard').classList.add('hidden');
  document.getElementById('status').textContent='leader';
  window.scrollTo(0,0);
}
function showRoundView(){
  document.getElementById('roundCard').classList.remove('hidden');
  document.getElementById('leaderCard').classList.add('hidden');
  document.getElementById('setupCard').classList.add('hidden');
  document.getElementById('status').textContent='live';
  if(state.rounds.length) showRound(state.cur);
}

/* ----- Leaderboard table fill ----- */
function updateLeaderboard(){
  var rows=state.names.map(function(n){return {name:n,rec:state.stats.get(n)||{w:0,d:0,l:0},pts:state.totals.get(n)||0};})
    .sort(function(a,b){ return (b.pts-a.pts) || a.name.localeCompare(b.name); });
  $('#leader').innerHTML='<tr><th>#</th><th>Player</th><th class="muted">Record</th><th>Points</th></tr>' +
    rows.map(function(r,i){ return '<tr><td>'+(i+1)+'</td><td>'+r.name+'</td><td>W:'+r.rec.w+' D:'+r.rec.d+' L:'+r.rec.l+'</td><td>'+r.pts+'</td></tr>'; }).join('');
}

/* ===== Equal rounds picker ===== */
function computeEqualOptions(nPlayers, courts){
  var capacity = 4 * courts;
  if(nPlayers<4 || capacity<4) return {base:0, options:[], capacity:capacity};
  var base = Math.floor(nPlayers / gcd(nPlayers, capacity));
  var options=[]; for(var k=1;k<=6;k++) options.push(base*k);
  return {base:base, options:options, capacity:capacity};
}
function getPlayersVal(){ var ta=document.getElementById('players'); return ta ? ta.value : ''; }
function getCourtsVal(){ var c=document.getElementById('courts'); return c ? +c.value : 2; }
function refreshEqualOptions(){
  var names = getPlayersVal().split(/\r?\n/).map(function(s){return s.trim();}).filter(function(x){return x;});
  var courts = getCourtsVal();
  var res = computeEqualOptions(names.length, courts);
  var base = res.base, options = res.options, capacity = res.capacity;
  var sel = $('#equalRounds'); var note = $('#equalNote');
  sel.innerHTML='';
  if(options.length===0){ note.textContent='Enter players & courts to see valid equal round counts.'; return; }
  for(var i=0;i<options.length;i++){
    var r=options[i];
    var plays = (capacity * r) / names.length;
    var sits = r - plays;
    var opt = document.createElement('option');
    opt.value = String(r);
    opt.textContent = r+' rounds — each plays '+plays+', sits '+sits;
    sel.appendChild(opt);
  }
  var plays0 = (capacity * options[0]) / names.length;
  var sits0 = options[0] - plays0;
  note.textContent = names.length+' players, '+courts+' courts ⇒ '+capacity+'/round. Minimal equal: '+base+' (each plays '+plays0+', sits '+sits0+').';
}

/* ===== Balanced Equal scheduler ===== */
function buildBalancedEqualSchedule(names, courts, totalRounds){
  var capacity = 4 * courts;
  var sitPerRound = names.length - capacity;
  if(sitPerRound < 0) throw new Error('More courts than players.');
  if(sitPerRound === 0) throw new Error('No sit-outs — use Auto/Custom mode.');

  var targetPlays = (capacity * totalRounds) / names.length;
  if(targetPlays !== Math.round(targetPlays)) throw new Error('Round count not equal-distributable.');

  var remSit = new Map(); names.forEach(function(n){ remSit.set(n, totalRounds - targetPlays); });
  var lastSit = new Set();
  var rounds = [];

  function chooseSitters(){
    var arr = names.slice().sort(function(a,b){
      var rsA = remSit.get(a), rsB = remSit.get(b);
      if(rsB !== rsA) return rsB - rsA;
      var penA = lastSit.has(a) ? 1 : 0;
      var penB = lastSit.has(b) ? 1 : 0;
      if(penA !== penB) return penA - penB;
      return Math.random() - 0.5;
    });
    var pick = [];
    for(var i=0;i<arr.length;i++){
      var p = arr[i];
      if(pick.length >= sitPerRound) break;
      if(remSit.get(p) > 0 && pick.indexOf(p)===-1){
        if(lastSit.has(p)){
          var othersAvailable = arr.filter(function(x){return !lastSit.has(x) && remSit.get(x)>0 && pick.indexOf(x)===-1;});
          if(othersAvailable.length >= (sitPerRound - pick.length)) continue;
        }
        pick.push(p);
      }
    }
    if(pick.length < sitPerRound){
      for(var j=0;j<names.length;j++){
        var q = names[j];
        if(pick.length >= sitPerRound) break;
        if(pick.indexOf(q)===-1 && (remSit.get(q)>0)) pick.push(q);
      }
    }
    return pick;
  }

  for(var r=0;r<totalRounds;r++){
    var sitters = chooseSitters();
    sitters.forEach(function(p){ remSit.set(p, remSit.get(p)-1); });
    var active = names.filter(function(n){ return sitters.indexOf(n)===-1; });
    var matches = pairUpUnique(active);
    rounds.push({ matches: matches, sit: sitters });
    lastSit = new Set(sitters);
  }
  remSit.forEach(function(rs){ if(rs !== 0) throw new Error('Internal: imbalance after scheduling.'); });
  return rounds;
}

/* ===== Fallback generator for Auto/Custom/Unlimited ===== */
function buildHeuristicSchedule(names, courts, totalRounds){
  var sitPerRound = names.length - 4*courts;
  var lastSit = new Set();
  var playQuota = new Map(names.map(function(n){return [n,0]}));
  var rounds=[];
  for(var r=0;r<totalRounds;r++){
    var arr = names.slice().sort(function(a,b){
      var pa=playQuota.get(a), pb=playQuota.get(b);
      if(pa!==pb) return pb-pa;
      var penA = lastSit.has(a)?1:0, penB = lastSit.has(b)?1:0;
      if(penA!==penB) return penA-penB;
      return Math.random()-0.5;
    });
    var sitters=[]; for(var i=0;i<arr.length && sitters.length<sitPerRound;i++){ var p=arr[i]; if(sitters.indexOf(p)===-1) sitters.push(p); }
    var active=names.filter(function(n){return sitters.indexOf(n)===-1;});
    var matches = pairUpUnique(active);
    active.forEach(function(p){ playQuota.set(p, playQuota.get(p)+1); });
    rounds.push({matches:matches, sit:sitters});
    lastSit = new Set(sitters);
  }
  return rounds;
}

/* ===== Setup & start ===== */
$('#roundsMode').addEventListener('change',function(){
  var mode=$('#roundsMode').value;
  $('#customRoundsWrap').classList.toggle('hidden', mode!=='custom');
  $('#equalWrap').classList.toggle('hidden', mode!=='equal');
  if(mode==='equal') refreshEqualOptions();
});
['input','change'].forEach(function(evt){
  $('#players').addEventListener(evt, function(){ if($('#roundsMode').value==='equal') refreshEqualOptions(); });
  $('#courts').addEventListener(evt, function(){ if($('#roundsMode').value==='equal') refreshEqualOptions(); });
});

$('#start').addEventListener('click',function(){
  try{
    clearErr();
    var raw = $('#players').value;
    var names=raw.split(/\r?\n/).map(function(s){return s.trim();}).filter(function(x){return x;});
    if(names.length<4){ alert('Need at least 4 players'); return; }
    state.names=names; state.courts=+$('#courts').value; state.points=+$('#points').value;
    state.results=[]; initStats();
    state.lastSit = new Set();
    state.pairCount = new Map(); // reset pair history (fresh event)

    var mode=$('#roundsMode').value; state.unlimited = (mode==='unlimited');
    var rounds=[];

    if(mode==='equal'){
      var target = +($('#equalRounds').value||0);
      if(!target){ alert('Pick an equal round count.'); return; }
      rounds = buildBalancedEqualSchedule(names, state.courts, target);
    }else{
      var totalRounds = (mode==='auto')
        ? ((names.length%2===1)? names.length : (names.length-1))
        : (mode==='custom' ? (+$('#customRounds').value||1) : 20);
      rounds = buildHeuristicSchedule(names, state.courts, totalRounds);
    }

    if(!rounds.length){ err('No rounds generated'); return; }

    state.rounds=rounds;
    document.getElementById('setupCard').classList.add('hidden');
    document.getElementById('roundCard').classList.remove('hidden');
    document.getElementById('leaderCard').classList.add('hidden');
    document.getElementById('btnLeaderboard').disabled=false;
    document.getElementById('status').textContent='live';
    showRound(0); updateLeaderboard();
  }catch(e){ console.error(e); err('Start error: '+(e.message||e)); }
});

/* ===== Navigation, scoring, reset ===== */
$('#prev').addEventListener('click',function(){ if(state.cur>0) showRound(state.cur-1); });
$('#next').addEventListener('click',function(){ if(state.cur<state.rounds.length-1) showRound(state.cur+1); });

$('#submit').addEventListener('click',function(){
  try{
    var r=state.rounds[state.cur]; var cards=$$('#matches .match'); var scores=[];
    for(var idx=0; idx<cards.length; idx++){
      var card=cards[idx]; var ins=card.querySelectorAll('input');
      var a=+ins[0].value, b=+ins[1].value;
      if(a+b!==state.points){ alert('Each match must sum to '+state.points); return; }
      scores.push({a:a,b:b});
    }
    state.results[state.cur]=scores;
    recomputeFromResults();
    updateLeaderboard();

    var isLastRound = (!state.unlimited && state.cur >= state.rounds.length-1);
    if(isLastRound){
      showLeaderboardView();
      alert('All rounds completed!');
    }else{
      showRound(state.cur+1);
    }
  }catch(e){ console.error(e); err('Submit error: '+(e.message||e)); }
});

/* Leaderboard buttons */
document.getElementById('btnLeaderboard').addEventListener('click', showLeaderboardView);
document.getElementById('closeLeader').addEventListener('click', showRoundView);

/* Resets */
function fullReset(){
  if(!confirm('Full reset and start over?')) return;
  state.names=[]; state.courts=2; state.points=24; state.rounds=[]; state.cur=0;
  state.totals=new Map(); state.results=[]; state.unlimited=false; state.stats=new Map(); state.lastSit = new Set(); state.pairCount=new Map();
  var ta = recreatePlayersTextarea(false);
  $('#courts').value=2; $('#points').value=24;
  $('#roundsMode').value='auto'; $('#customRounds').value=9; $('#customRoundsWrap').classList.add('hidden');
  $('#equalWrap').classList.add('hidden'); $('#equalRounds').innerHTML=''; $('#equalNote').textContent='';
  $('#matches').innerHTML=''; $('#leader').innerHTML='<tr><th>#</th><th>Player</th><th class="muted">Record</th><th>Points</th></tr>';
  document.getElementById('setupCard').classList.remove('hidden');
  document.getElementById('roundCard').classList.add('hidden');
  document.getElementById('leaderCard').classList.add('hidden');
  document.getElementById('btnLeaderboard').disabled=true;
  document.getElementById('status').textContent='ready';
  window.scrollTo(0,0);
  if(ta) ta.focus();
  clearErr();
}
function resetKeepPlayers(){
  if(!confirm('Reset event but keep players?')) return;
  var currentTa = document.getElementById('players');
  var preserved = (currentTa && currentTa.value) ? currentTa.value.trim() : '';
  state.names=[]; state.courts=2; state.points=24; state.rounds=[]; state.cur=0;
  state.totals=new Map(); state.results=[]; state.unlimited=false; state.stats=new Map(); state.lastSit = new Set(); state.pairCount=new Map();
  var ta = recreatePlayersTextarea(true); if(ta) ta.value = preserved;
  $('#courts').value=2; $('#points').value=24;
  $('#roundsMode').value='auto'; $('#customRounds').value=9; $('#customRoundsWrap').classList.add('hidden');
  $('#equalWrap').classList.add('hidden'); $('#equalRounds').innerHTML=''; $('#equalNote').textContent='';
  $('#matches').innerHTML=''; $('#leader').innerHTML='<tr><th>#</th><th>Player</th><th class="muted">Record</th><th>Points</th></tr>';
  document.getElementById('setupCard').classList.remove('hidden');
  document.getElementById('roundCard').classList.add('hidden');
  document.getElementById('leaderCard').classList.add('hidden');
  document.getElementById('btnLeaderboard').disabled=true;
  document.getElementById('status').textContent='ready';
  window.scrollTo(0,0);
  if(ta) ta.focus();
  clearErr();
}
$('#btnReset').addEventListener('click', fullReset);
$('#btnResetKeep').addEventListener('click', resetKeepPlayers);
</script>
</body>
</html>
